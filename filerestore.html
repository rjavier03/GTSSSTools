<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>B2BE SQL Template Generator</title>

<style>
  :root{
    --bg:#071025;
    --panel:#0b1220;
    --muted:#94a3b8;
    --accent:#7dd3fc;
    --border:rgba(255,255,255,0.08);
    --text:#e6eef6;
    --output-bg:#020617;
  }

  html,body{
    height:100%;
    margin:0;
    background:linear-gradient(180deg,var(--bg),#071a2a);
    color:var(--text);
    font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial;
  }

  .wrap{
    max-width:880px;
    margin:40px auto;
    padding:24px;
    background:var(--panel);
    border-radius:12px;
    box-shadow:0 8px 30px rgba(2,6,23,.6);
    border:1px solid var(--border);
  }

  header {
    display:flex;
    align-items:center;
    justify-content:space-between;
    margin-bottom:16px;
    border-bottom:1px solid var(--border);
    padding-bottom:12px;
  }
  header h1 {
    font-size:22px;
    color:var(--accent);
    margin:0;
    letter-spacing:0.5px;
  }
  header .tagline {
    font-size:13px;
    color:var(--muted);
  }

  label {
    font-weight:600;
    color:var(--accent);
    margin-bottom:4px;
    display:block;
    font-size:14px;
  }

  input[type="text"], input[type="file"] {
    width:100%;
    padding:10px;
    border-radius:8px;
    border:1px solid var(--border);
    background:#031022;
    color:var(--text);
    font-family:ui-monospace,monospace;
    font-size:14px;
    box-sizing:border-box;
  }

  textarea {
    width:100%;
    background:var(--output-bg);
    color:#cdeffc;
    border:1px solid var(--border);
    border-radius:8px;
    padding:12px;
    font-family:ui-monospace,monospace;
    font-size:13px;
    resize:vertical;
    min-height:250px;
    box-sizing:border-box;
    white-space:pre-wrap;
    margin-top:12px;
  }

  button {
    background:linear-gradient(180deg,#0b1220,#071022);
    border:1px solid var(--border);
    color:var(--text);
    padding:10px 14px;
    border-radius:8px;
    cursor:pointer;
    transition:all 0.2s ease;
    font-size:14px;
    margin-right:8px;
  }
  button:hover { background:linear-gradient(180deg,#0d1b33,#0b1a29); }
  button.primary { background:linear-gradient(180deg,#007b8f,#006a7a);font-weight:600; }
  button.copy-btn {
    background:linear-gradient(180deg,#1e293b,#0f172a);
    border:1px solid var(--border);
    color:var(--accent);
    font-weight:600;
    transition:all 0.2s ease;
  }
  button.copy-btn:hover {
    background:linear-gradient(180deg,#0284c7,#0369a1);
    color:#fff;
    transform:translateY(-1px);
  }

  .section-title {
    margin-top:20px;
    font-size:15px;
    color:var(--accent);
    font-weight:600;
  }

  .grid { display:grid; gap:1rem; grid-template-columns:1fr 1fr; }
</style>
</head>
<body>

<div class="wrap">
  <header>
    <h1>B2BE SQL Template Generator</h1>
    <span class="tagline">Infra & GP Automation Helper</span>
  </header>

  <div class="section">
    <label for="archiveDate">1️⃣ Archive Date/s</label>
    <input type="text" id="archiveDate" placeholder="Enter archive date/s (e.g. 2020-02-04)">
  </div>

  <div class="grid">
    <div class="section">
      <label for="fileDocument">2️⃣ Upload B2BE_DOCUMENT.sql</label>
      <input type="file" id="fileDocument" accept=".sql">
    </div>

    <div class="section">
      <label for="fileAction">3️⃣ Upload B2BE_DOCUMENT_ACTION.sql</label>
      <input type="file" id="fileAction" accept=".sql">
    </div>
  </div>

  <div style="margin-top:20px;">
    <button class="primary" onclick="generateTemplate()">Generate Message</button>
    <button class="copy-btn" onclick="copyText()">Copy Message</button>
  </div>

  <textarea id="output" placeholder="Generated message will appear here..."></textarea>
</div>

<script>
let documentSQL = "";
let actionSQL = "";

function generateTemplate() {
  const docFile = document.getElementById('fileDocument').files[0];
  const actFile = document.getElementById('fileAction').files[0];
  const archiveDate = document.getElementById('archiveDate').value.trim();
  const output = document.getElementById('output');

  if (!archiveDate) {
    alert('Please enter the Archive Date/s.');
    return;
  }
  if (!docFile || !actFile) {
    alert('Please upload both SQL files.');
    return;
  }

  const docReader = new FileReader();
  const actReader = new FileReader();

  docReader.onload = e => {
    documentSQL = extractInsertQueries(e.target.result);
    actReader.readAsText(actFile);
  };

  actReader.onload = e => {
    const actionText = e.target.result;
    actionSQL = extractInsertQueries(actionText);
    const locations = extractLocations(actionText);
    output.value = buildTemplate(documentSQL, actionSQL, locations, archiveDate);
  };

  docReader.readAsText(docFile);
}

function extractInsertQueries(sqlText) {
  const queries = sqlText.match(/INSERT INTO[\s\S]*?;/gi);
  return queries ? queries.join("\n") : "No INSERT INTO found.";
}

function extractLocations(sqlText) {
  const regex = /\(\s*\d+,\s*\d+,\s*'[^']*',\s*'[^']*',\s*'([^']+)'/g;
  const locations = new Set();
  let match;
  while ((match = regex.exec(sqlText)) !== null) {
    locations.add(match[1]);
  }
  return Array.from(locations);
}

function getExpiryDate() {
  const date = new Date();
  date.setMonth(date.getMonth() + 1);
  const yyyy = date.getFullYear();
  const mm = String(date.getMonth() + 1).padStart(2, '0');
  const dd = String(date.getDate()).padStart(2, '0');
  return `${yyyy}-${mm}-${dd} 23:59:59`;
}

function buildTemplate(documentQuery, actionQuery, locations, archiveDate) {
  const docIDMatch = documentQuery.match(/\((\d+)/);
  const docID = docIDMatch ? docIDMatch[1] : "????";
  const expiryDate = getExpiryDate();
  const locationList = locations.length ? locations.join("\n") : "(No locations found)";

  const expirySQL = `
TABLE NAME: B2BE_DOCUMENT_EXPIRY

INSERT INTO \`B2BE_DOCUMENT_EXPIRY\` (
\`B2BEDocumentInternalID\`,
\`ExpiryDateTime\`
)
VALUES (
'${docID}', '${expiryDate}'
);`;

  return `Hi Infra,

Please restore the following file:
Archive Date/s: ${archiveDate}

${locationList}

Hi GP,

Please execute the below SQL query in PROD:
DATABASE NAME: B2BE_Server
Table: B2BE_DOCUMENT

${documentQuery}

TABLE NAME: B2BE_DOCUMENT_ACTION

${actionQuery}

${expirySQL}
`;
}

function copyText() {
  const output = document.getElementById('output');
  output.select();
  document.execCommand("copy");
  alert("Message copied to clipboard!");
}
</script>

</body>
</html>
